<!DOCTYPE html>
<html>
<head>
  <title>Trading Dashboard</title>

  <!-- Chart.js + plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

  <style>
    body {
      font-family: Arial;
      margin: 40px;
      max-width: 1200px;
    }

    table {
      border-collapse: collapse;
      margin-bottom: 30px;
      width: 100%;
    }

    table, th, td {
      border: 1px solid #ccc;
      padding: 6px 12px;
      text-align: left;
    }

    th {
      background: #f5f5f5;
    }

    .chart-box {
      display: inline-block;
      width: 46%;
      height: 320px;
      vertical-align: top;
      margin-right: 2%;
    }
  </style>
</head>

<body>

<h2>Trade Analytics Dashboard</h2>

<!-- ================= SUMMARY TABLE ================ -->
<h3>Summary per Symbol</h3>

<table id="summaryTable">
  <thead>
    <tr>
      <th>Symbol</th>
      <th>Total Volume</th>
      <th>Total Value</th>
      <th>Net Position</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- ================= PIE CHART ================= -->
<h3>Distribution (Pie Chart)</h3>

<label><b>Select metric:</b></label>
<select id="metricSelect">
  <option value="TotalVolume">Total Volume</option>
  <option value="TotalValue">Total Value</option>
  <option value="NetPosition">Net Position</option>
</select>

<label style="margin-left:20px;">
  <input type="checkbox" id="togglePercent"> Show percentages
</label>

<div class="chart-box">
  <canvas id="pieChart"></canvas>
</div>

<!-- ================= LINE CHART ================= -->
<h3>Trend Chart</h3>

<select id="symbolSelect"></select>

<div class="chart-box" style="width: 100%; height: 350px;">
  <canvas id="trendChart"></canvas>
</div>


<script>
let summaryData = [];
let pieChart;
let lineChart;

/* ================= LOAD SUMMARY ================= */
async function loadSummary() {
  const res = await fetch("/api/summary");
  summaryData = await res.json();

  const tbody = document.querySelector("#summaryTable tbody");
  const symbolSelect = document.getElementById("symbolSelect");

  summaryData.forEach(row => {
    tbody.innerHTML += `
      <tr>
        <td>${row.Symbol}</td>
        <td>${row.TotalVolume}</td>
        <td>${row.TotalValue.toFixed(2)}</td>
        <td>${row.NetPosition}</td>
      </tr>
    `;

    symbolSelect.innerHTML += `<option value="${row.Symbol}">${row.Symbol}</option>`;
  });

  buildPieChart("TotalVolume", false);
}

/* ================= PIE CHART ================= */
function buildPieChart(metric, showPercent) {
  const labels = summaryData.map(r => r.Symbol);
  const values = summaryData.map(r => r[metric]);
  const total = values.reduce((a, b) => a + b, 0);

  const colors = [
    "#9b1d5a", "#e67e22", "#1abc9c", "#34495e", "#f39c12"
  ];

  if (pieChart) pieChart.destroy();

  const ctx = document.getElementById("pieChart").getContext("2d");

  pieChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "right" },
        datalabels: {
          color: "#fff",
          font: { weight: "bold", size: 12 },
          formatter: (value) => {
            if (!showPercent) return value;
            return ((value / total) * 100).toFixed(1) + "%";
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

/* PIE events */
document.getElementById("metricSelect").addEventListener("change", (e) => {
  buildPieChart(e.target.value, document.getElementById("togglePercent").checked);
});

document.getElementById("togglePercent").addEventListener("change", (e) => {
  buildPieChart(
    document.getElementById("metricSelect").value,
    e.target.checked
  );
});

/* ================ LINE CHART (TREND) ================= */
async function loadTrend(symbol) {
  const res = await fetch(`/api/trend/${symbol}`);
  const data = await res.json();

  const dates = data.map(x => x.Date);
  const volumes = data.map(x => x.Volume);

  if (lineChart) lineChart.destroy();

  const ctx = document.getElementById("trendChart").getContext("2d");

  lineChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: dates,
      datasets: [{
        label: `Daily Volume â€“ ${symbol}`,
        data: volumes,
        borderColor: "#3498db",
        backgroundColor: "rgba(52,152,219,0.3)",
        borderWidth: 2,
        pointRadius: 3,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "top" },
        zoom: {
          zoom: {
            wheel: { enabled: true },
            pinch: { enabled: true },
            mode: "xy"
          },
          pan: {
            enabled: true,
            mode: "xy"
          }
        }
      },
      scales: {
        x: {
          type: "time",
          time: { unit: "day" }
        }
      }
    }
  });
}

document.getElementById("symbolSelect").addEventListener("change", e => {
  loadTrend(e.target.value);
});

/* ================= INIT ================= */
loadSummary().then(() => {
  const first = document.getElementById("symbolSelect").value;
  loadTrend(first);
});
</script>

</body>
</html>
